<!DOCTYPE html>
<meta charset="utf-8">
<title>Denver Crime Map</title>
<head>
  <!-- load jquery BEFORE bootstrap for tooltips, etc to work properly -->
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="http://bootswatch.com/darkly/bootstrap.min.css">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <script src="heatmap.js"></script>
  <script src="leaflet-heatmap.js"></script>
  <style>
    <!-- CSS overrides must come after bootstrap.css loaded -->
    html, body {
      height: 100%;
      min-height: 100%;
    }

    .dropdown-menu {
      width: 100%;
    }

    .tooltip-inner {
      text-align: left;
      max-width: 500px;
      white-space: pre-wrap;
    }

    .pad-button-bottom {
      margin-bottom: 0.2%;
    }

    .pad-bottom {
      margin-bottom: 1%;
    }

    #map-row, .progress {
      background-color: #222222;
      height: 12px;
      border-radius: 0px;
    }
    #map-row .progress-bar {
      line-height: 12px;
    }

    #navbar {
      background-color: #303030;
      border-radius: 3px;
    }

    .navbar-header {
      float: none;
    }

    .navbar-toggle {
      display: initial;
      float: right;
    }

  </style>
  <title>Denver Crime Map</title>
</head>

<body>
<div class="container-fluid">
  <div class="row-fluid">
    <div class="col-xs-12">
      <nav class="navbar navbar-default" id="navbar">
        <div class="navbar-header">
          <p class="navbar-brand">
            Denver Crime Map
            <br><small>Geographic and temporal crime trends (March 2015)</small>
          </p>
          <button type="button" class="navbar-toggle" data-toggle="modal"
                  data-target="#description">
            <span class="glyphicon glyphicon-question-sign"></span>
          </button>
        </div>
      </nav>
    </div>
  </div>
</div>
<div class="container-fluid">
  <div id="controls">
    <div id="help-crime" data-toggle="tooltip" title="help text not injected">
      <div class="row-fluid">
        <div class="col-xs-12 pad-button-bottom">
          <div class="dropdown" >
            <button type="button" class="btn btn-default btn-block btn-xs"
                    id="crime-button" data-toggle="dropdown">
              Select crime category <span class="caret"></span></button>
            <ul class="dropdown-menu" id="crime">
              <!-- menu items generated by d3 -->
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div id="help-time" data-toggle="tooltip" title="help text not injected">
      <div class="row-fluid">
        <div class="col-xs-12 pad-button-bottom">
          <div class="dropdown">
            <button type="button" class="btn btn-default btn-block btn-xs"
                    id="time-button" data-toggle="dropdown">
              Select time unit <span class="caret"></span></button>
            <ul class="dropdown-menu" id="time-unit">
              <li>
                <a href="#" onclick="set_unit('linear');">
                  <div class="help-time" data-toggle="tooltip" title="help text not injected">
                    Default
                  </div>
                </a>
              </li>
              <li>
                <a href="#" onclick="set_unit('hour');">
                  <div class="help-time" data-toggle="tooltip" title="help text not injected">
                    Hour of the day
                  </div>
                </a>
              </li>
              <li>
                <a href="#" onclick="set_unit('day');">
                  <div class="help-time" data-toggle="tooltip" title="help text not injected">
                    Day of the week
                  </div>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div id="help-run" data-toggle="tooltip" title="help text not injected">
      <div class="row-fluid">
        <div class="col-xs-12 pad-bottom">
          <button type="button" id="start" class="btn btn-success btn-block btn-xs"
                  onclick="animate_map();">Run visualization</button>
        </div>
      </div>
    </div>
  </div>
  <div id="map-row" class="row-fluid">
    <div class="col-xs-12">
      <div id="map" class=""></div>
      <div class="progress">
        <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="0"
             aria-valuemin="0" aria-valuemax="100" style="width:0%">
        </div>
      </div>
    </div>
  </div>

  <!-- Description -->
  <div id="description" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          header
        </div>
        <div class="modal-body">
          body text
        </div>
        <div class="modal-footer">
          put link to data source here.
        </div>
      </div>
    </div>
  </div>

</div>
<script type="text/javascript">

  // define local data location
  var fname = 'crime_cats_201503';
  var text_fname = 'write-up.txt';
  var data_fpath = 'data/' + fname + '.topojson';

  // store all time-unit specific global parameters in vars class
  function vars(unit) {
    this.unit = unit;
    var weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday',
      'Friday', 'Saturday'];
    params = {
      'linear': {
        n: 14, speed: 500, label: "Default", format: function(d) {
          return 'Day ' + d;
        } },
      'hour': {
        n: 3, speed: 800, label: "Aggregate by hour of the day", format: function(d) {
          return d + ':00 - ' + d + ':59';
        }},
      'day': {
        n:2, speed: 1200, label: "Aggregate by day of the week", format: function(d) {
          return weekdays[d];
        }}
    };

    this.n = params[unit].n;
    this.speed =  params[unit].speed;  // max datum val/intervals visible (?)
    this.label = params[unit].label;
    this.format_time = params[unit].format;
  }

  // declare global vars (for debug)
  var full_data = [];
  var features;
  var crimes;
  var crime_selected;
  var params;
  var intervals;  // need global access to cancel

  ///////////// heatmap.js /////////////
  var config = {
    "radius": 15,
    "maxOpacity": 0.9,
    "minOpacity": 0,
    "scaleRadius": false,
    "useLocalExtrema": false,
    "blur": 0.75,
    latField: 'lat',
    lngField: 'lng',
    valueField: 'val'
  };

  // initialize heatmap overlay
  var heatmap = new HeatmapOverlay(config);

  var heatmap_data;  // set in set_unit

  ///////////// leaflet.js ////////////
  function map_height () {
    return $(window).height()
        - $("#map-row").offset().top
        - $(document).scrollTop();
  }

  function resize(){
    $('#map').css("height", map_height());
  }

  $('#map').css("height", map_height());

  $(window).on("resize", resize);
  resize();

  var base = new L.TileLayer(
      "http://{s}.tiles.mapbox.com/v4/circld.b689c053/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY2lyY2xkIiwiYSI6IjE5MjJCN2MifQ.Ztr1z4FvXHYHFQCxEubPpw"
  );

  var map = L.map('map', {
    center: new L.LatLng(39.737, -104.981),
    zoomControl: false,
    minZoom: 12,
    maxZoom: 13,
    zoom: 13,
    layers: [base, heatmap]
  });

  //////////// animation ////////////
  // add capitalize string method
  String.prototype.capitalize = function() {
    // replace hyphens and cap first letter in each word
    return this.replace(/-/g, ' ')
        .replace(/\b\w/g, function (m) {
          return m.toUpperCase();
        });
  };

  function set_unit(unit) {

    params = new vars(unit);

    heatmap_data = {
      max: 4 * params.n,  // what's an appropriate scaling factor for max?
      min: 0,
      data: []
    };

    d3.select("#time-button")
        .html(params.label + ' <span class="caret"></span>')
  }

  function aggregate(datetime) {
    if (params.unit === "linear") {
      return datetime.getDate();
    } else if (params.unit === "hour") {
      return datetime.getHours();
    } else {
      return datetime.getDay();
    }
  }

  function update_progress(cur, last, clear) {
    clear = typeof clear !== 'undefined' ? 1 : 0;
    // not strictly correct % for month case
    var pct = clear ? 0 : Math.ceil(100 * (cur + 1) / (last + 1));
    var text = clear ? "" : params.format_time(cur);
    if (cur <= last) {
      console.log(Math.ceil(pct));
      d3.select(".progress-bar")
          .attr({
            "aria-valuenow": pct,
            style: "width:" + pct + "%"
          })
          .text(text);
    }
  }
  // helper function to push features data into full_data
  function get_coords(element, index, array) {

    var el_type = element.properties.OFFENSE_CATEGORY_ID;

    if (crime_selected === 'all' || crime_selected === el_type) {
      full_data.push({
//        datetime: new Date(element.properties.FIRST_OCCURRENCE_DATE),
        crime: el_type,
        shown: false,
        unit: aggregate(new Date(element.properties.FIRST_OCCURRENCE_DATE)),

        // required heatmap.js vars
        lat: element.geometry.coordinates[1],
        lng: element.geometry.coordinates[0],
        val: 0
      });
    }
  }

  // reset for next animation
  function reset() {
    clearInterval(intervals);
    toggle_run();

    heatmap_data.data = [{
      // dummy point to ensure all heatmap points removed from map
      lat: 0.0,
      lng: 0.0,
      val: 0
    }];
    heatmap.setData(heatmap_data);
    update_progress(0, 100, 1);  // clear progress bar

    full_data = [];
    $(window).scrollTop(0);
    return true;
  }

  // toggle run viz button
  function toggle_run() {

    if (!(crime_selected)) {
      return false;
    }

    var button = d3.select("#start");
    if (button.text() === 'Run visualization') {
      button.text("Stop visualization")
          .attr("onclick", "reset();")
          .classed({ "btn-danger": true , "btn-success": false});
    } else {
      button.text("Run visualization")
          .attr("onclick", "animate_map();")
          .classed({ "btn-success": true , "btn-danger": false});
    }
  }

  // run heatmap animation
  function animate_map() {

    if (!(crime_selected) || !(params)) {
      return false;
    }

    toggle_run();

    // populate heatmap_data arrays
    features.forEach(get_coords);

    // determine date range
    var datetime_extent = d3.extent(full_data, function(d) {
      return d.unit;
    });

    if (!(datetime_extent)) {
      alert("No observations.");
    }

    // must create new date or will overwrite datetime for datum
    var curr_time = datetime_extent[0];
    var last_time = datetime_extent[1];

    // allow points to fade (larger # intervals, no need for extra time for fade)
    last_time += Math.floor(12 / params.n) + params.n;

    function add_next_data() {

      // change curr_time
      update_progress(curr_time, datetime_extent[1]);
      curr_time += 1;

      // update current data slice in heatmap_data.data
      heatmap_data.data.forEach(function (element, array, index) {
        if (element.shown && element.val === 0) {
          heatmap_data.data.splice(index, 1);
        }
        if (element.val > 0) {
          element.val -= 1;
        }
      });

      // push qualifying points from full_data into heatmap_data.data
      // note: will need to reset shown & val if reusing full_data
      full_data.forEach( function(element, array, index) {
        if (!element.shown && element.unit < curr_time) {
          element.shown = true;
          element.val = params.n;
          heatmap_data.data.push(element);
        }
      });

      // display curr_time in DOM object
      if (curr_time <= datetime_extent[1]) {
        d3.select("#date_display")
            .text(params.format_time(curr_time));
      } else {
        d3.select("#date_display")
            .text(" ");
      }

      // update map data points
      heatmap.setData(heatmap_data);

      // reset once current_time > last_time
      if (curr_time > last_time) {
        console.log(heatmap_data.data.filter(function(element, array, index) {
          return element.val === 0;
        }));
        clearInterval(intervals);
        return reset();
      }
    }

    // call add_next_data for each speed interval
    intervals = setInterval(add_next_data, params.speed);

    // scroll to see time/progress bar
    $(window).scrollTop( $(document).height());

  }

  //////////// Reading data & dynamic DOM generation/manipulation ///////////
  d3.json(data_fpath, function(error, data) {

    if (error) return console.error(error);

    // store data in global var
    features = topojson.feature(data, data.objects[fname]).features;

    // crime types
    crimes = d3.set();
    features.forEach(
        function(el, ar, idx) {
          crimes.add(el.properties.OFFENSE_CATEGORY_ID);
        }
    );
    crimes = crimes.values().sort();
    crimes.unshift('all');

    // create crime type dropdown items
    d3.select("#crime")
        .selectAll("li")
        .data(crimes)
        .enter()
        .append("li")
        .append("a")
        .attr("href", "#")
        .text(function(d) { return d.capitalize(); })
        // add event listeners for items (update button text accordingly)
        .on("click", function(d, i) {
          crime_selected = crimes[i];
          d3.select("#crime-button")
              .html(
                  crime_selected.capitalize() + ' <span class="caret"></span>'
          );
        });

  });

  //////////// Modal & Tooltips ////////////
  // inject help text into tooltip
  var help_run =
      "Press 'Run visualization' to begin " +
      "and 'Stop visualization' to start over\n" +
      "(Not working? Make sure you have selected a crime category and time unit!)";
  var help_crime = "Would you like to see all crimes or a specific type of crime?";
  var help_time = [
    "Visualize the data by day of the month",
    "Aggregate the data by hour of the day",
    "Aggregate the data by day of the week"
  ];
  var help_time_menu = "Should the observations be shown chronologically or be aggregated?";
  d3.select("#help-run")
      .attr("title", help_run);
  d3.select("#help-crime")
      .attr("title", help_crime);
  d3.selectAll(".help-time")
      .attr("title", function(d, i) { return help_time[i]; });
  d3.select("#help-time")
      .attr("title", help_time_menu);

  // insert modal text
  $(document).ready(function () {
    $(".modal-header").html( function() {
      var close_icon = $("<button type='button' class='close' data-dismiss='modal'>&times;</button>");
      return close_icon;
    });
    $(".modal-header").append( function() {
          var title = $("<h3>").text("Denver Crime Map");
          var author = $("<small>").text("Paul Garaud");
          return title.append( $("<br>") ).append( author );
        });
    $(".modal-body").load(text_fname);
    $(".modal-footer").html("<span>Data source:&nbsp;&nbsp;</span>")
        .append( function() {
          return $("<a/>").attr('href',
          'http://data.denvergov.org/dataset/city-and-county-of-denver-crime')
              .text("Denver crime data");
        })
        .append( function() {
          var retrieved = '4/13/2015';
          return "<br><span><small> data retrieved on " + retrieved + "</small></span>";
    });
  });

  // initialize tooltip(s)
  $(document).ready(function() {
    $('[data-toggle="tooltip"]').tooltip();
  });

</script>
